#!/usr/bin/env bash
BUILD_TYPE=${1:-base}
BUILD_NAME=${2:-demo}
BUILD_VERSION=${3:-latest}
BUILD_ARGS=${@:4:99}
export BUILD_REGISTRY=${BUILD_REGISTRY}

docker_build() {
  local image=$1
  local version=$2
  local file=$3
  local args=${@:4:99}
  local tag="$image:$version"
  if [ ! -z $BUILD_REGISTRY ]
  then 
    local tag="${BUILD_REGISTRY}/${image}:$version"
  fi
  docker build -t $tag $file $args ./
  echo $tag
}

base() {
  docker_build \
    ${BUILD_NAME}-base \
    $BUILD_VERSION \
    -f docker_src/Dockerfile.BASE \
    $BUILD_ARGS
}

builder() {
  docker_build \
    ${BUILD_NAME}-builder \
    $BUILD_VERSION \
    -f docker_src/Dockerfile.BUILDER \
    --build-arg BUILD_VERSION=$BUILD_VERSION \
    --build-arg PROJECT_BRANCH=$BUILD_VERSION \
    $BUILD_ARGS
}

freeze() {
  docker_build \
    $BUILD_NAME \
    $BUILD_VERSION \
    -f docker_src/Dockerfile.FREEZE \
    $BUILD_ARGS
}

case $BUILD_TYPE in
base)
  IMAGE_TAG=$(base)
  ;;
builder)
  IMAGE_TAG=$(builder)
  ;;
freeze) 
  IMAGE_TAG=$(freeze)
  ;;
full)
  base && builder
  IMAGE_TAG=$(freeze)
esac

echo "$IMAGE_TAG"
